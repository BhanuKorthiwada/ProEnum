parameters:
  buildConfig: $(BuildConfig)
  nugetSource: $(NuGetPrivateSource)
  nugetApiKey: $(NuGetPrivateApiKey)
  solution: $(DotNetSolution)

jobs:
  - job: BuildPackPush
    continueOnError: true
    pool:
      vmImage: $(BuildImage)
    steps:
      - task: UseDotNet@2
        displayName: "Setup : .NET Core SDK"
        inputs:
          packageType: sdk
          version: 5.0.x
          includePreviewVersions: true
          installationPath: $(Agent.ToolsDirectory)/dotnet

      - script: dotnet build ${{ parameters.solution }} -c ${{ parameters.buildConfig }}
        displayName: "Build"

      - script: dotnet pack ${{ parameters.solution }} -c ${{ parameters.buildConfig }} -o $(Build.ArtifactStagingDirectory) --include-symbols --include-source
        displayName: "Pack"

      - task: DotNetCoreCLI@2
        inputs:
          command: "push"
          packagesToPush: "$(Build.ArtifactStagingDirectory)/*.nupkg"
          nuGetFeedType: "internal"
          publishVstsFeed: "377aecd9-7ece-4d91-b4a6-3c46305db51b/2192b590-17a3-4d7d-8a46-0aad423ec3e1"
          allowPackageConflicts: true

      - script: dotnet nuget push "$(Build.ArtifactStagingDirectory)/*.nupkg" -s ${{ parameters.nugetSource }} --api-key ${{ parameters.nugetApiKey }} --skip-duplicate
        displayName: "Push"
